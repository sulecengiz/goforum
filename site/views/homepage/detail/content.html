{{ define "content" }}
<header class="masthead" style="background-image: url('/{{ .Post.Picture_url }}')">
    <div class="overlay"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <div class="post-heading">
                    <h1>{{ .Post.Title }}</h1>
                    <h2 class="subheading">{{ .Post.Description }}</h2>
                </div>
            </div>
        </div>
    </div>
</header>

<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <!-- Blog İçerik -->
                <div id="blog-content" class="blog-content mb-5">{{ .Post.Content }}</div>

                <!-- Yorumlar -->
                <div class="comments-section">
                    <h3 class="mb-4">Yorumlar ({{ .TotalComments }})</h3>

                    <!-- Yorum Formu -->
                    <div class="comment-form-container mt-5">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title mb-4" id="form-title">Yorum Yap</h4>
                                <form id="comment-form" action="/yazilar/{{ .Post.Slug }}/yorum-ekle" method="POST">
                                    <input type="hidden" name="parent_id" id="parent-id-input">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Adınız</label>
                                        <input type="text" class="form-control" id="name" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="comment" class="form-label">Yorumunuz</label>
                                        <textarea class="form-control" id="comment" name="comment" rows="4" required></textarea>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <button type="submit" class="btn btn-primary">Gönder</button>
                                        <button type="button" id="cancel-reply" class="btn btn-primary" style="display: none;">
                                            Yanıtı İptal Et
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Yorum Listesi -->
                    <div class="comment-list">
                        {{ if .Comments }}
                        {{ template "renderComment" .Comments }}
                        {{ else }}
                        <div class="alert" style="background-color: rgba(193,164,125,0.25); color: #49391e">Henüz yorum yapılmamış. İlk yorumu siz yapın!</div>
                        {{ end }}
                    </div>
                </div> <!-- comments-section -->
            </div>
        </div>
    </div>
</article>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Blog içeriğini set et
        const blogContent = document.getElementById("blog-content");
        if (blogContent) {
            blogContent.innerHTML = `{{ .Post.Content }}`;
        }

        // Alt yorumları göster/gizle butonları
        document.querySelectorAll('.toggle-replies-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const targetDiv = document.getElementById(targetId);

                if (!targetDiv) return;

                if (targetDiv.style.display === 'none' || targetDiv.style.display === '') {
                    targetDiv.style.display = 'block';
                    this.textContent = this.textContent.replace('Göster', 'Gizle');
                } else {
                    targetDiv.style.display = 'none';
                    this.textContent = this.textContent.replace('Gizle', 'Göster');
                }
            });
        });

        // Yanıtla butonları
        const commentForm = document.getElementById('comment-form');
        const parentIdInput = document.getElementById('parent-id-input');
        const commentTextarea = document.getElementById('comment');
        const formTitle = document.getElementById('form-title');
        const cancelReplyBtn = document.getElementById('cancel-reply');

        document.querySelectorAll('.reply-btn').forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const replyTo = this.getAttribute('data-reply-to');

                parentIdInput.value = commentId;
                commentTextarea.placeholder = `@${replyTo} kullanıcısına yanıtınızı yazın...`;
                formTitle.textContent = `@${replyTo} kullanıcısına yanıt yazıyorsunuz`;
                cancelReplyBtn.style.display = 'inline-block';

                commentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                commentTextarea.focus();
            });
        });

        cancelReplyBtn.addEventListener('click', function() {
            parentIdInput.value = '';
            commentTextarea.placeholder = 'Yorumunuzu yazın...';
            formTitle.textContent = 'Yorum Yap';
            cancelReplyBtn.style.display = 'none';
            commentTextarea.focus();
        });

        // --- BEĞENİ BUTONU KODU İÇİN DEĞİŞİKLİKLER ---

            const LIKED_COMMENTS_KEY = 'likedComments';

            // 1. Sayfa yüklendiğinde mevcut beğeni durumunu kontrol et
            function checkInitialLikeStatus() {
                try {
                    // localStorage'dan beğeni verilerini al, yoksa boş bir nesne oluştur
                    const likedComments = JSON.parse(localStorage.getItem(LIKED_COMMENTS_KEY)) || {};

                    // Tüm beğeni butonlarını seç (dinamik içerik için her seferinde yeniden seç)
                    const likeButtons = document.querySelectorAll('.like-btn');
                    console.log('Bulunan buton sayısı:', likeButtons.length);

                    // Her bir beğeni butonu için
                    likeButtons.forEach(button => {
                        const commentId = button.getAttribute('data-comment-id');
                        const icon = button.querySelector('.like-icon');

                        if (!commentId || !icon) {
                            console.warn('Eksik data-comment-id veya like-icon:', button);
                            return;
                        }

                        // Eğer yorumun ID'si localStorage'da varsa, dolu kalp yap
                        if (likedComments[commentId]) {
                            icon.classList.remove('far', 'fa-heart');
                            icon.classList.add('fas', 'fa-heart');
                        } else {
                            // Değilse boş kalp yap
                            icon.classList.remove('fas', 'fa-heart');
                            icon.classList.add('far', 'fa-heart');
                        }
                    });

                    console.log('Yüklenen beğeniler:', likedComments);
                } catch (error) {
                    console.error('checkInitialLikeStatus hatası:', error);
                }
            }

            // 2. Beğenme/Beğenmeme işlemini yöneten ana fonksiyon
            function handleLike(event) {
                event.preventDefault();
                event.stopPropagation();

                try {
                    const button = this;
                    const commentId = button.getAttribute('data-comment-id');
                    const icon = button.querySelector('.like-icon');

                    if (!commentId || !icon) {
                        console.error('Eksik data-comment-id veya like-icon');
                        return;
                    }

                    // localStorage'dan mevcut beğeni durumunu al
                    let likedComments = JSON.parse(localStorage.getItem(LIKED_COMMENTS_KEY)) || {};

                    if (likedComments[commentId]) {
                        // Eğer daha önce beğenilmişse, beğeniyi kaldır
                        delete likedComments[commentId];
                        icon.classList.remove('fas', 'fa-heart');
                        icon.classList.add('far', 'fa-heart');
                        console.log('Beğeni kaldırıldı:', commentId);
                    } else {
                        // Beğenilmemişse, beğen
                        likedComments[commentId] = true;
                        icon.classList.remove('far', 'fa-heart');
                        icon.classList.add('fas', 'fa-heart');
                        console.log('Beğenildi:', commentId);
                    }

                    // Değişikliği localStorage'a geri kaydet
                    localStorage.setItem(LIKED_COMMENTS_KEY, JSON.stringify(likedComments));

                } catch (error) {
                    console.error('handleLike hatası:', error);
                }
            }

            // 3. Event listener'ları ekle (event delegation kullanarak)
            function attachLikeListeners() {
                // Mevcut listener'ları kaldır
                document.removeEventListener('click', handleLikeClick);

                // Yeni listener ekle (event delegation)
                document.addEventListener('click', handleLikeClick);
            }

            // Event delegation handler
            function handleLikeClick(event) {
                if (event.target.closest('.like-btn')) {
                    const button = event.target.closest('.like-btn');
                    handleLike.call(button, event);
                }
            }

            // 4. Sayfa yükleme ve dinamik içerik için
            function initializeLikeSystem() {
                attachLikeListeners();

                // Kısa bir gecikme ile kontrol et (DOM güncellemeleri için)
                setTimeout(() => {
                    checkInitialLikeStatus();
                }, 100);
            }

            // 5. MutationObserver - dinamik içerik değişikliklerini izle
            const observer = new MutationObserver(function(mutations) {
                let shouldCheck = false;

                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Yeni node'lar eklendi, beğeni butonları var mı kontrol et
                        for (let node of mutation.addedNodes) {
                            if (node.nodeType === 1) { // Element node
                                if (node.querySelector && node.querySelector('.like-btn')) {
                                    shouldCheck = true;
                                    break;
                                }
                            }
                        }
                    }
                });

                if (shouldCheck) {
                    setTimeout(checkInitialLikeStatus, 50);
                }
            });

            // Observer'ı başlat
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            // İlk başlatma
            initializeLikeSystem();

            // Manuel olarak yeniden kontrol etme fonksiyonu (gerekirse)
            window.refreshLikeStatus = checkInitialLikeStatus;

            console.log('Beğeni sistemi başlatıldı');

    });

</script>
{{ end }}